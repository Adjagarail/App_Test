security:
  password_hashers:
    Symfony\Component\Security\Core\User\PasswordAuthenticatedUserInterface: 'auto'
    App\Entity\User: 'auto'

  # Hiérarchie des rôles
  role_hierarchy:
    ROLE_SEMI_ADMIN: ROLE_USER
    ROLE_MODERATOR: ROLE_USER
    ROLE_ANALYST: ROLE_USER
    ROLE_ADMIN: [ROLE_SEMI_ADMIN, ROLE_MODERATOR, ROLE_ANALYST]
    ROLE_SUPER_ADMIN: ROLE_ADMIN

  providers:
    app_user_provider:
      entity:
        class: App\Entity\User
        property: email

  firewalls:
    dev:
      pattern: ^/(_profiler|_wdt|assets|build)/
      security: false

    # Firewall pour la connexion - POST /api/login_check retourne un JWT
    login:
      pattern: ^/api/login
      stateless: true
      provider: app_user_provider
      user_checker: App\Security\UserChecker
      json_login:
        check_path: /api/login_check
        username_path: email
        password_path: password
        success_handler: lexik_jwt_authentication.handler.authentication_success
        failure_handler: lexik_jwt_authentication.handler.authentication_failure

    # Firewall pour refresh token - POST /api/token/refresh
    refresh:
      pattern: ^/api/token/refresh
      stateless: true
      user_checker: App\Security\UserChecker

    # Firewall principal - toutes les autres routes protégées par JWT
    main:
      stateless: true
      provider: app_user_provider
      user_checker: App\Security\UserChecker
      jwt: ~

  # Contrôle d'accès
  access_control:
    # Routes publiques (pas d'authentification requise)
    - { path: ^/api/login, roles: PUBLIC_ACCESS }
    - { path: ^/api/token/refresh, roles: PUBLIC_ACCESS }
    - { path: ^/api/password, roles: PUBLIC_ACCESS }  # Reset password
    - { path: ^/api/auth/verify-email, roles: PUBLIC_ACCESS }  # Email verification
    - { path: ^/api/auth/resend-verification, roles: PUBLIC_ACCESS }  # Resend verification
    - { path: ^/register, roles: PUBLIC_ACCESS }
    - { path: ^/$, roles: PUBLIC_ACCESS }  # Page d'accueil
    - { path: ^/jwt-example.html, roles: PUBLIC_ACCESS }  # Page de test

    # Routes super admin - ROLE_SUPER_ADMIN requis
    - { path: ^/api/admin/users/\d+/impersonate, roles: ROLE_SUPER_ADMIN }
    - { path: ^/api/admin/impersonation, roles: ROLE_SUPER_ADMIN }

    # Routes admin - ROLE_ADMIN requis
    - { path: ^/api/admin, roles: ROLE_ADMIN }

    # Dashboard accessible aux semi-admin et admin
    - { path: ^/api/dashboard, roles: [ROLE_SEMI_ADMIN, ROLE_ADMIN] }

    # Toutes les autres routes nécessitent une authentification
    - { path: ^/, roles: IS_AUTHENTICATED_FULLY }
