<div class="profile-container">
  <header class="profile-header">
    <h1>Mon Profil</h1>
  </header>

  <!-- Success Message -->
  @if (successMessage()) {
    <div class="success-message">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      {{ successMessage() }}
    </div>
  }

  <!-- Error Message -->
  @if (error()) {
    <div class="error-message">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      {{ error() }}
    </div>
  }

  @if (loading()) {
    <div class="loading-state">
      <div class="spinner-large"></div>
      <p>Chargement du profil...</p>
    </div>
  }

  @if (profileData() && !loading()) {
    <div class="profile-content">
      <!-- Profile Card -->
      <div class="profile-card">
        <div class="avatar">
          <span>{{ profileData()?.nomComplet?.charAt(0)?.toUpperCase() || profileData()?.email?.charAt(0)?.toUpperCase() }}</span>
        </div>

        <div class="profile-info">
          @if (!editMode()) {
            <h2>{{ profileData()?.nomComplet || 'Nom non défini' }}</h2>
            <p class="email">{{ profileData()?.email }}</p>
            <div class="roles">
              @for (role of profileData()?.roles; track role) {
                <span class="role-badge" [class]="getRoleBadgeClass(role)">
                  {{ role }}
                </span>
              }
            </div>
            <button class="btn btn-outline btn-small" (click)="startEdit()">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
              </svg>
              Modifier
            </button>
          } @else {
            <!-- Edit Mode -->
            <div class="edit-form">
              <div class="form-group">
                <label>Nom complet</label>
                <input
                  type="text"
                  [ngModel]="editForm().nomComplet"
                  (ngModelChange)="updateEditForm('nomComplet', $event)"
                  placeholder="Votre nom complet"
                />
              </div>
              <div class="form-group">
                <label>Email</label>
                <input type="email" [value]="profileData()?.email" disabled />
                <span class="field-note">L'email ne peut pas être modifié</span>
              </div>
              <div class="form-actions">
                <button class="btn btn-primary" (click)="saveProfile()" [disabled]="savingProfile()">
                  {{ savingProfile() ? 'Sauvegarde...' : 'Sauvegarder' }}
                </button>
                <button class="btn btn-secondary" (click)="cancelEdit()" [disabled]="savingProfile()">
                  Annuler
                </button>
              </div>
            </div>
          }
        </div>
      </div>

      <!-- Account Details -->
      <div class="info-card">
        <h3>Informations du compte</h3>
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Date d'inscription</span>
            <span class="info-value">{{ formatDateString(profileData()?.dateInscription) }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Derniere connexion</span>
            <span class="info-value">{{ formatDateString(profileData()?.dateDerniereConnexion) }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Email verifie</span>
            <span class="info-value" [class.verified]="profileData()?.isEmailVerified" [class.not-verified]="!profileData()?.isEmailVerified">
              {{ profileData()?.isEmailVerified ? 'Oui' : 'Non' }}
            </span>
          </div>
        </div>
      </div>

      <!-- Session Info -->
      <div class="info-card">
        <h3>Informations de session</h3>
        <div class="token-info">
          <div class="info-row">
            <span class="label">Token expire le:</span>
            <span class="value">{{ formatDate(tokenExpiration()) }}</span>
          </div>
          <button class="btn btn-outline" (click)="refreshToken()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="18" height="18">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            Rafraichir le token
          </button>
        </div>
      </div>

      <!-- Password Change -->
      <div class="info-card">
        <h3>Securite</h3>
        @if (!passwordMode()) {
          <p class="card-description">Modifiez votre mot de passe pour securiser votre compte.</p>
          <button class="btn btn-outline" (click)="startPasswordChange()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="18" height="18">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
            </svg>
            Changer le mot de passe
          </button>
        } @else {
          <div class="password-form">
            <div class="form-group">
              <label>Mot de passe actuel</label>
              <input
                type="password"
                [ngModel]="passwordForm().currentPassword"
                (ngModelChange)="updatePasswordForm('currentPassword', $event)"
                placeholder="Votre mot de passe actuel"
              />
            </div>
            <div class="form-group">
              <label>Nouveau mot de passe</label>
              <input
                type="password"
                [ngModel]="passwordForm().newPassword"
                (ngModelChange)="updatePasswordForm('newPassword', $event)"
                placeholder="Minimum 6 caracteres"
              />
            </div>
            <div class="form-group">
              <label>Confirmer le nouveau mot de passe</label>
              <input
                type="password"
                [ngModel]="passwordForm().confirmNewPassword"
                (ngModelChange)="updatePasswordForm('confirmNewPassword', $event)"
                placeholder="Confirmez le nouveau mot de passe"
              />
            </div>
            <div class="form-actions">
              <button class="btn btn-primary" (click)="savePassword()" [disabled]="savingPassword()">
                {{ savingPassword() ? 'Modification...' : 'Modifier le mot de passe' }}
              </button>
              <button class="btn btn-secondary" (click)="cancelPasswordChange()" [disabled]="savingPassword()">
                Annuler
              </button>
            </div>
          </div>
        }
      </div>

      <!-- Admin Notice -->
      @if (isAdmin() || isSuperAdmin()) {
        <div class="admin-notice" [class.super-admin]="isSuperAdmin()">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="24" height="24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
          </svg>
          <div>
            <strong>{{ isSuperAdmin() ? 'Super Administrateur' : 'Administrateur' }}</strong>
            <p>Vous avez acces au dashboard administrateur{{ isSuperAdmin() ? ' et a l\'impersonation' : '' }}.</p>
          </div>
        </div>
      }

      <!-- Data Export (GDPR) -->
      <div class="info-card">
        <h3>Mes donnees (RGPD)</h3>
        <p class="card-description">Telechargez une copie de toutes vos donnees personnelles.</p>
        <button class="btn btn-outline" (click)="exportData()" [disabled]="exporting()">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="18" height="18">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
          </svg>
          {{ exporting() ? 'Export en cours...' : 'Exporter mes donnees' }}
        </button>
      </div>

      <!-- Account Deletion Request -->
      <div class="danger-card">
        <h3>Zone de danger</h3>
        @if (hasPendingDeleteRequest()) {
          <div class="pending-request-notice">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Une demande de suppression de compte est en cours de traitement.</span>
          </div>
        } @else if (!deleteRequestMode()) {
          <p class="card-description">Une fois votre compte supprime, toutes vos donnees seront definitivement perdues.</p>
          <button class="btn btn-danger" (click)="startDeleteRequest()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="18" height="18">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
            Demander la suppression du compte
          </button>
        } @else {
          <div class="delete-form">
            <p class="warning-text">Cette action enverra une demande aux administrateurs qui devront l'approuver.</p>
            <div class="form-group">
              <label>Raison (optionnel)</label>
              <textarea
                [ngModel]="deleteReason()"
                (ngModelChange)="deleteReason.set($event)"
                placeholder="Pourquoi souhaitez-vous supprimer votre compte ?"
                rows="3"
              ></textarea>
            </div>
            <div class="form-actions">
              <button class="btn btn-danger" (click)="submitDeleteRequest()" [disabled]="requestingDelete()">
                {{ requestingDelete() ? 'Envoi...' : 'Confirmer la demande' }}
              </button>
              <button class="btn btn-secondary" (click)="cancelDeleteRequest()" [disabled]="requestingDelete()">
                Annuler
              </button>
            </div>
          </div>
        }
      </div>
    </div>
  }
</div>
