<!-- Impersonation Banner -->
@if (isImpersonating()) {
  <div class="impersonation-banner">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
    </svg>
    <span>Vous agissez en tant que <strong>{{ impersonationState().targetUser?.email }}</strong></span>
    <button class="stop-impersonation-btn" (click)="stopImpersonation()">
      Arrêter l'impersonation
    </button>
  </div>
}

<nav class="navbar" [class.dark]="darkMode()" [class.with-impersonation]="isImpersonating()">
  <!-- Logo -->
  <div class="navbar-brand">
    <a routerLink="/" class="logo">SAMA APPLI</a>
  </div>

  <!-- Hamburger Menu (Mobile) -->
  <button class="hamburger" (click)="toggleMobileMenu()" [class.active]="mobileMenuOpen()">
    <span></span>
    <span></span>
    <span></span>
  </button>

  <!-- Main Menu -->
  <div class="navbar-menu" [class.mobile-open]="mobileMenuOpen()">
    @if (isAuthenticated()) {
      <!-- Navigation Links -->
      <div class="navbar-links">
        <a routerLink="/profile" routerLinkActive="active" (click)="mobileMenuOpen.set(false)">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="18" height="18">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
          Profil
        </a>
        @if (canAccessDashboard()) {
          <a routerLink="/dashboard" routerLinkActive="active" (click)="mobileMenuOpen.set(false)">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="18" height="18">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
            </svg>
            Dashboard
          </a>
        }
      </div>

      <!-- Actions (Notifications, Theme, User) -->
      <div class="navbar-actions">
        <!-- Dark Mode Toggle -->
        <button class="action-btn theme-toggle" (click)="toggleDarkMode()" title="Changer le thème">
          @if (darkMode()) {
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
          } @else {
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
          }
        </button>

        <!-- Report/Contact Admin Button (for all authenticated users) -->
        <button class="action-btn report-btn" (click)="openReportModal()" title="Contacter l'admin">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
          </svg>
          @if (myReportsUnreadCount() > 0) {
            <span class="notification-badge">{{ myReportsUnreadCount() }}</span>
          }
        </button>

        <!-- Notifications (Admin only) -->
        @if (canViewNotifications()) {
          <div class="notifications-container">
            <button class="action-btn notifications-btn" (click)="toggleNotifications()">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
              </svg>
              @if (unreadCount() > 0) {
                <span class="notification-badge">{{ unreadCount() > 99 ? '99+' : unreadCount() }}</span>
              }
            </button>

          @if (notificationsOpen()) {
            <div class="notifications-dropdown">
              <div class="notifications-header">
                <h3>Notifications</h3>
                @if (unreadCount() > 0) {
                  <button class="mark-all-read" (click)="markAllNotificationsAsRead()">Tout marquer lu</button>
                }
              </div>
              <div class="notifications-list">
                @if (notifications().length === 0) {
                  <div class="no-notifications">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="40" height="40">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                    </svg>
                    <p>Aucune notification</p>
                  </div>
                } @else {
                  @for (notification of notifications(); track notification.id) {
                    <div
                      class="notification-item"
                      [class.unread]="!notification.read"
                      [class]="'type-' + notification.type"
                      (click)="navigateToNotification(notification)"
                    >
                      <div class="notification-icon">
                        @switch (notification.type) {
                          @case ('success') {
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                          }
                          @case ('warning') {
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                          }
                          @case ('error') {
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                          }
                          @default {
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                          }
                        }
                      </div>
                      <div class="notification-content">
                        <p class="notification-title">{{ notification.title }}</p>
                        <p class="notification-message">{{ notification.message }}</p>
                      </div>
                    </div>
                  }
                }
              </div>
            </div>
          }
          </div>
        }

        <!-- User Dropdown -->
        <div class="user-dropdown-container">
          <button class="user-trigger" (click)="toggleDropdown()">
            <div class="avatar">{{ userInitials() }}</div>
            <div class="user-info">
              <span class="user-name">{{ displayName() }}</span>
              <span class="user-role" [class]="roleClass()">{{ primaryRole() }}</span>
            </div>
            <svg class="chevron" [class.rotated]="dropdownOpen()" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>

          @if (dropdownOpen()) {
            <div class="user-dropdown">
              <div class="dropdown-header">
                <div class="avatar large">{{ userInitials() }}</div>
                <div class="header-info">
                  <span class="header-name">{{ displayName() }}</span>
                  <span class="header-email">{{ currentUser()?.email }}</span>
                </div>
              </div>
              <div class="dropdown-divider"></div>
              <div class="dropdown-menu">
                <button class="dropdown-item" (click)="navigateTo('/profile')">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                  </svg>
                  Mon Profil
                </button>
                @if (canAccessDashboard()) {
                  <button class="dropdown-item" (click)="navigateTo('/dashboard')">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                    </svg>
                    Dashboard
                  </button>
                }
              </div>
              <div class="dropdown-divider"></div>
              <button class="dropdown-item logout" (click)="logout()">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
                Se Déconnecter
              </button>
            </div>
          }
        </div>
      </div>
    } @else {
      <!-- Non-authenticated menu -->
      <div class="navbar-auth">
        <button class="action-btn theme-toggle" (click)="toggleDarkMode()" title="Changer le thème">
          @if (darkMode()) {
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
          } @else {
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
          }
        </button>
        <a routerLink="/login" routerLinkActive="active" class="btn-link">
          Connexion
        </a>
        <a routerLink="/register" routerLinkActive="active" class="btn-register">
          Inscription
        </a>
      </div>
    }
  </div>
</nav>

<!-- Report Chat Modal -->
@if (reportModalOpen()) {
  <div class="modal-overlay" (click)="closeReportModal()">
    <div class="report-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        @if (reportChatOpen() && selectedReport()) {
          <button class="back-btn" (click)="backToReportsList()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
          </button>
          <h3>{{ selectedReport()?.subject || 'Conversation' }}</h3>
        } @else if (reportChatOpen()) {
          <button class="back-btn" (click)="backToReportsList()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
          </button>
          <h3>Nouveau message</h3>
        } @else {
          <h3>Mes messages</h3>
        }
        <button class="close-btn" (click)="closeReportModal()">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <div class="modal-body">
        @if (reportLoading()) {
          <div class="loading-spinner">
            <div class="spinner"></div>
            <span>Chargement...</span>
          </div>
        } @else if (reportChatOpen() && selectedReport()) {
          <!-- Chat view for existing thread -->
          <div class="chat-messages">
            @for (msg of reportMessages(); track msg.id) {
              <div class="chat-message" [class.own]="msg.type === 'USER_MESSAGE'" [class.admin]="msg.type === 'ADMIN_RESPONSE'" [class.system]="msg.type === 'SYSTEM'">
                <div class="message-header">
                  <span class="sender">{{ msg.type === 'USER_MESSAGE' ? 'Vous' : (msg.type === 'ADMIN_RESPONSE' ? 'Admin' : 'Système') }}</span>
                  <span class="time">{{ msg.createdAt | date:'dd/MM/yyyy HH:mm' }}</span>
                </div>
                <div class="message-content">{{ msg.message }}</div>
              </div>
            }
            @if (reportMessages().length === 0) {
              <div class="no-messages">Aucun message dans cette conversation.</div>
            }
          </div>

          @if (selectedReport()?.status !== 'CLOSED') {
            <div class="chat-input">
              <input
                type="text"
                [(ngModel)]="chatMessage"
                placeholder="Écrire un message..."
                (keyup.enter)="sendReportMessage()"
              />
              <button class="send-btn" (click)="sendReportMessage()" [disabled]="!chatMessage().trim()">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
              </button>
            </div>
          } @else {
            <div class="thread-closed">Cette conversation est fermée.</div>
          }
        } @else if (reportChatOpen()) {
          <!-- New report form -->
          <div class="new-report-form">
            <div class="form-group">
              <label for="reportSubject">Sujet (optionnel)</label>
              <input
                type="text"
                id="reportSubject"
                [(ngModel)]="newReportSubject"
                placeholder="Ex: Question sur mon compte"
              />
            </div>
            <div class="form-group">
              <label for="reportMessage">Message *</label>
              <textarea
                id="reportMessage"
                [(ngModel)]="newReportMessage"
                rows="5"
                placeholder="Décrivez votre problème ou posez votre question..."
              ></textarea>
            </div>
            <button class="submit-btn" (click)="submitNewReport()" [disabled]="!newReportMessage().trim()">
              Envoyer le message
            </button>
          </div>
        } @else {
          <!-- Reports list -->
          <div class="reports-list-container">
            <button class="new-report-btn" (click)="openNewReportForm()">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
              Nouveau message
            </button>

            @if (myReports().length === 0) {
              <div class="no-reports">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="48" height="48">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                </svg>
                <p>Aucun message pour le moment</p>
                <span>Cliquez sur "Nouveau message" pour contacter un administrateur</span>
              </div>
            } @else {
              <div class="reports-list">
                @for (report of myReports(); track report.id) {
                  <div class="report-item" [class.unread]="!report.isRead" (click)="openReportThread(report)">
                    <div class="report-info">
                      <span class="report-subject">{{ report.subject || 'Sans sujet' }}</span>
                      <span class="report-preview">{{ report.lastMessage }}</span>
                      <span class="report-date">{{ report.createdAt | date:'dd/MM/yyyy HH:mm' }}</span>
                    </div>
                    <span class="report-status" [class]="getStatusClass(report.status)">
                      {{ getStatusLabel(report.status) }}
                    </span>
                  </div>
                }
              </div>
            }
          </div>
        }
      </div>
    </div>
  </div>
}
